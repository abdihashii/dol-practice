# Decentralized Open Library (DoL) Program

A Solana smart contract for managing a decentralized digital library with on-chain metadata and IPFS content storage.

## Overview

The DoL program enables:

- **Free Library Cards**: Users mint NFTs for library access (no UUID required)
- **Decentralized Book Catalog**: On-chain metadata with IPFS content links
- **Role-Based Access Control**: Super admin, admins, and curators
- **UUID v4 Validation**: Ensures unique book identifiers
- **Program Controls**: Pause/unpause functionality for emergencies

## Architecture

### Account Structures

#### DoLState (Global Program State)

```rust
pub struct DoLState {
    pub super_admin: Pubkey,     // Current super admin with full control
    pub admins: Vec<Pubkey>,     // Library admins (can add/remove books, manage roles)
    pub moderators: Vec<Pubkey>, // Moderators (can flag content, limited admin powers)
    pub curators: Vec<Pubkey>,   // Curators (can add books but not remove)
    pub book_count: u64,         // Total books added (for analytics and metrics)
    pub version: u8,             // Program version for future upgrades
    pub flags: u8,               // Bit flags: bit 0 = is_paused
    pub bump: u8,                // PDA bump seed
    // Super admin transfer security fields
    pub pending_super_admin: Option<Pubkey>, // Pending new super admin (if transfer initiated)
    pub transfer_initiated_at: i64,          // Timestamp when transfer was initiated
    pub transfer_timelock: i64,              // Required delay before transfer can be confirmed (default: 7 days)
    // Emergency recovery fields
    pub emergency_recovery_threshold: u8,        // Number of admin signatures required for emergency recovery
    pub emergency_recovery_initiated_at: i64,    // Timestamp when emergency recovery was initiated
    pub emergency_recovery_votes: Vec<Pubkey>,   // Admins who have voted for emergency recovery
    pub emergency_recovery_new_admin: Option<Pubkey>, // Proposed new super admin for recovery
    pub reserved: [u8; 4],                       // Reserved space for future features
}
```

#### LibraryCard (User Access NFT)

```rust
pub struct LibraryCard {
    pub owner: Pubkey,       // Card holder's wallet address
    pub mint_timestamp: i64, // When card was minted
    pub bump: u8,            // PDA bump seed
    pub reserved: [u8; 48],  // Reserved space for future features
}
```

#### Book (Catalog Entry)

```rust
pub struct Book {
    pub id: [u8; 16],          // Unique book ID (UUID v4 generated by client)
    pub title: String,         // Book title (1-100 chars)
    pub author: String,        // Author name (1-50 chars)
    pub ipfs_hash: String,     // IPFS hash pointing to book content (CIDv0/CIDv1)
    pub genre: String,         // Book genre/category (1-30 chars)
    pub publication_year: u16, // Publication year (optional, 0 if unknown)
    pub added_timestamp: i64,  // When book was added to catalog
    pub added_by: Pubkey,      // Who added this book (for audit trail)
    pub bump: u8,              // PDA bump seed
    pub reserved: [u8; 32],    // Reserved space for future features
}
```

### Program Instructions

| Instruction                     | Authority         | Description                                  |
| ------------------------------- | ----------------- | -------------------------------------------- |
| `initialize`                    | Super Admin       | One-time program setup                       |
| `mint_library_card`             | Any User          | Mint access NFT (one per wallet)             |
| `add_book`                      | Admin/Curator     | Add book with UUID validation                |
| `update_book`                   | Admin/Curator     | Update book metadata                         |
| `remove_book`                   | Admin Only        | Remove book from catalog                     |
| `get_book`                      | Public            | Read book information                        |
| `verify_access`                 | Public            | Verify library card ownership                |
| `add_admin`                     | Super Admin/Admin | Add new admin                                |
| `remove_admin`                  | Super Admin       | Remove admin                                 |
| `add_curator`                   | Admin             | Add curator                                  |
| `remove_curator`                | Admin             | Remove curator                               |
| `initiate_super_admin_transfer` | Super Admin       | Start timelock for super admin transfer      |
| `confirm_super_admin_transfer`  | Super Admin       | Complete super admin transfer after timelock |
| `cancel_super_admin_transfer`   | Super Admin       | Cancel pending super admin transfer          |
| `initiate_emergency_recovery`   | Admin             | Start emergency recovery process             |
| `vote_emergency_recovery`       | Admin             | Vote for emergency recovery                  |
| `cancel_emergency_recovery`     | Super Admin       | Cancel emergency recovery process            |
| `pause_program`                 | Super Admin       | Emergency pause                              |
| `unpause_program`               | Super Admin       | Resume operations                            |

### PDA Derivations

```rust
// Global state (singleton)
[b"dol_state"]

// Library card (one per user)
[b"library_card", user_pubkey]

// Book (by UUID)
[b"book", book_uuid_bytes]
```

## Key Features

- **UUID Optimization**: Library cards no longer require UUIDs, unlimited scalability
- **Enhanced Security**: Timelock transfers and emergency recovery mechanisms
- **Comprehensive Validation**: UUID v4, IPFS hash, and input sanitization
- **Role-Based Access**: Hierarchical permission system with audit trails

### Storage Costs

- **DoLState**: ~800 bytes (includes security fields)
- **LibraryCard**: ~90 bytes per user
- **Book**: ~200-350 bytes depending on metadata length

## Security Features

### Input Validation

- **String Validation**: Prevents injection attacks
- **IPFS Hash Validation**: Ensures valid CIDv0/CIDv1 format
- **UUID v4 Validation**: Checks version and variant bits
- **Length Limits**: Prevents oversized transactions

### Access Control

```rust
// Role hierarchy
Super Admin > Admin > Curator > User

// Permissions
- Super Admin: Full control, transfer role, emergency controls
- Admin: Manage books and curators, emergency recovery voting
- Curator: Add books only
- User: Read access with library card
```

### Super Admin Transfer Security

The program implements a secure two-step super admin transfer process:

1. **Initiate Transfer**: Current super admin calls `initiate_super_admin_transfer`
   - Starts 7-day timelock period
   - Validates new super admin address
   - Prevents self-transfer and invalid addresses

2. **Confirm Transfer**: After timelock expires, current super admin calls `confirm_super_admin_transfer`
   - Completes the transfer
   - Clears pending transfer state
   - Logs security event

3. **Cancel Transfer**: Current super admin can cancel pending transfer anytime

### Emergency Recovery System

If super admin key is lost or compromised:

1. **Admin Voting**: Any admin can initiate emergency recovery
   - Requires minimum 2 admin signatures
   - Proposes new super admin address
   - Validates proposed address

2. **Consensus**: Other admins vote using `vote_emergency_recovery`
   - Each admin can vote once
   - Recovery executes when threshold reached
   - Logs all votes and execution

3. **Safeguards**: Current super admin can cancel recovery if still accessible

### Error Handling

Key error codes:

- `InvalidBookId`: UUID validation failed
- `InsufficientPermissions`: Role check failed
- `ProgramPaused`: Operations blocked
- `InvalidInput`: Validation failed

## Quick Start

### Prerequisites

- Rust 1.75+
- Solana CLI 1.18+
- Anchor 0.30+

### Build

```bash
anchor build
```

### Test

```bash
anchor test
```

### Deploy

```bash
# Local
anchor deploy

# Devnet
anchor deploy --provider.cluster devnet
```

## Configuration

### Program ID

Update in `Anchor.toml`:

```toml
[programs.localnet]
dol_program = "DoLotrsAZR2JYa4tjue2c5q4EYKMbm6kxcrvjbU5cxX5"
```

### Super Admin

Hardcoded in `lib.rs`:

```rust
pub const SUPER_ADMIN: &str = "AfuXGptXuHDGpnAL5V27fUkNkHTVcDPGgF1cGbmTena";
```

## Testing

See the comprehensive [DoL Program Testing Guide](../../../docs/DOL_PROGRAM_TESTING_GUIDE.md) for:

- Local testnet setup
- Devnet deployment
- Test scenarios
- Troubleshooting

## Future Enhancements

- User collections and bookshelves
- Reading progress tracking
- Community reviews and ratings
- Annotation system
- DAO governance transition

## License

This program is part of the Decentralized Open Library project, designed to provide permanent, censorship-resistant access to public domain literature.
